"use strict";function setUserName(e){global.user||(global.user=e,document.title="["+e+"] "+document.title)}function startTimers(){window.setInterval(function(){global.connected&&global.ws.emit("player_stats")},3e5),window.setInterval(function(){global.connected&&global.map.updatePokestopsStatus()},6e4)}function startListenToSocket(){inventory.init(global.config.locale),console.log("Connecting to "+global.config.websocket),startTimers();var e=localStorage.getItem("pokemonSettings");e?global.pokemonSettings=JSON.parse(e):global.pokemonSettings={};var o=io.connect(global.config.websocket+"/event");global.ws=o,o.on("connect",function(){console.log("Connected to Bot"),global.connected=!0,$(".loading").text("Waiting to get GPS coordinates from Bot...")}),o.on("disconnect",function(){global.connected=!1}),o.on("bot_initialized",function(e){e.username&&(console.log("Bot Ready."),console.log(e),setUserName(e.username),global.player=e.player,global.player&&($(".player").trigger("pogo:player_update"),ga("send","event","level",global.player.level)),e.storage&&(global.storage={pokemon:e.storage.max_pokemon_storage,items:e.storage.max_item_storage}),global.map.addToPath({lat:e.coordinates[0],lng:e.coordinates[1]})),$(".toolbar div").show(),global.ws.emit("pokemon_settings")}),o.on("pokemon_settings",function(e){global.pokemonSettings=e,localStorage.setItem("pokemonSettings",JSON.stringify(global.pokemonSettings))}),o.on("player_stats",function(e){global.player=e.player,$(".player").trigger("pogo:player_update")}),o.on("position",function(e){global.snipping||global.map.addToPath({lat:e.coordinates[0],lng:e.coordinates[1]})}),o.on("pokestops",function(e){var o=Array.from(e.pokestops.filter(function(e){return 1==e.fort_type}),function(e){return{id:e.fort_id,lat:e.latitude,lng:e.longitude,cooldown:parseInt(e.cooldown_timestamp_ms)||null,lureExpire:parseInt(e.lure_expires_timestamp_ms)||null}});global.map.addPokestops(o)}),o.on("pokestop_visited",function(e){console.log("Pokestop Visited"),global.map.addVisitedPokestop({id:e.pokestop.fort_id,name:"",lat:e.pokestop.latitude,lng:e.pokestop.longitude,cooldown:parseInt(e.pokestop.cooldown_timestamp_ms)||null,lureExpire:parseInt(e.pokestop.lure_expires_timestamp_ms)||null,visited:!0})}),o.on("pokemon_caught",function(e){console.log("Pokemon caught");var o=e.pokemon,t={id:o.pokemon_id,name:inventory.getPokemonName(o.pokemon_id),cp:o.combat_power,iv:(100*o.potential).toFixed(1),lvl:inventory.getPokemonLevel(o)};e.position&&(t.lat=e.position.latitude,t.lng=e.position.longitude),global.map.addCatch(t),pokemonToast(t,{ball:o.pokeball})}),o.on("transfered_pokemon",function(e){}),o.on("pokemon_evolved",function(e){var o={id:e.evolution,name:inventory.getPokemonName(e.evolution)},t=inventory.getPokemonName(e.pokemon.pokemon_id);pokemonToast(o,{title:"A "+t+" Evolved"})}),o.on("inventory_list",function(e){var o=Array.from(Object.keys(e.inventory).filter(function(e){return"count"!=e}),function(o){var t=parseInt(o);return{item_id:t,name:inventory.getItemName(t),count:e.inventory[o]}});global.map.displayInventory(o)}),o.on("pokemon_list",function(e){console.log(e);var o=Array.from(e.pokemon,function(o){var t=global.pokemonSettings[o.pokemon_id-1]||{};return{id:o.unique_id,pokemonId:o.pokemon_id,inGym:null!=o.deployed_fort_id,canEvolve:t.evolution_ids&&t.evolution_ids.length>0,cp:o.combat_power,iv:(100*o.potential).toFixed(1),lvl:inventory.getPokemonLevel(o),name:o.nickname||inventory.getPokemonName(o.pokemon_id),candy:e.candy[t.family_id]||0,candyToEvolve:t.candy_to_evolve,favorite:o.favorite>0,stats:{atk:o.attack,def:o.defense,hp:o.hp,maxHp:o.max_hp,sta:o.stamina}}});global.map.displayPokemonList(o,null,e.eggs_count)}),o.on("eggs_list",function(e){var o=e.egg_incubators.filter(function(e){return 0!=e.target_km_walked||0!=e.start_km_walked});o=Array.from(o,function(o){return e.km_walked=e.km_walked||0,{type:901==o.item_id?"incubator-unlimited":"incubator",totalDist:o.target_km_walked-o.start_km_walked,doneDist:e.km_walked-o.start_km_walked}});var t=Array.from(e.egg_incubators,function(e){return e.pokemon_id}),n=Array.from(e.eggs.filter(function(e){return t.indexOf(e.unique_id)<0}),function(e){return{type:"egg",totalDist:e.total_distance,doneDist:e.walked_distance}});global.map.displayEggsList(o.concat(n))}),o.on("pokemon_found",function(e){console.log(e)}),o.on("player_update",function(e){console.log(e)})}function errorToast(e){toastr.error(e,"Error",{progressBar:!0,positionClass:"toast-top-right",timeOut:"5000",closeButton:!0})}function pokemonToast(e,o){if(!global.config.noPopup){o=o||{};var t=o.title||(global.snipping?"Snipe success":"Catch success"),n=global.snipping?toastr.success:toastr.info,i=e.name;e.lvl&&(i+=" (lvl "+e.lvl+")");var s="<div>"+i+"</div><div>";s+="<img src='./assets/pokemon/"+e.id+".png' height='50' />",o.ball&&(s+="<img src='./assets/inventory/"+o.ball+".png' height='30' />"),s+="</div>",n(s,t,{progressBar:!0,positionClass:"toast-top-right",timeOut:"5000",closeButton:!0})}}!function(){function e(e){for(var o=window.location.search.substring(1),t=o.split("&"),n=0;n<t.length;n++){var i=t[n].split("=");if(i[0]==e)return i[1]}}var o={locale:"en",websocket:"http://localhost:8000",followPlayer:!1,noPopup:!1,noConfirm:!1,memory:{limit:!1,maxCaught:50,mathPath:1e4,maxPokestops:250}},t={};if("function"==typeof require){var n,i,s,a;!function(){console.log("Load config from disk"),n=require("path"),i=require("fs");var e=require("electron");s=e.remote,a=n.join(s.app.getPath("userData"),"settings.json");var r=require("./package.json"),l=r.version;t.save=function(e){i.writeFileSync(a,JSON.stringify(e))},t.load=function(){var e=o;try{e=JSON.parse(i.readFileSync(a,"utf-8")),e=Object.assign({},o,e),e.version=l,e.websocket.startsWith("ws")&&(e.websocket=o.websocket),e.memory=o.memory}catch(e){configService.save(o)}return e}}()}else console.log("Load config from storage"),t.load=function(){var t=Object.assign({},o),n=localStorage.getItem("config");n&&Object.assign(t,JSON.parse(n)),t.websocket.startsWith("ws")&&(t.websocket=o.websocket);var i=e("websocket");return i&&(console.log(i),t.websocket=i),t.version="online",t.memory=o.memory,t},t.save=function(e){console.log(e),localStorage.setItem("config",JSON.stringify(e))};window.configService=t}(),function(){function e(e){e=e||"en",$.ajax({url:"assets/json/pokemon."+e+".json",async:!1,success:function(e){o="string"==typeof e?JSON.parse(e):e}}),$.ajax({url:"assets/json/inventory."+e+".json",async:!1,success:function(e){t="string"==typeof e?JSON.parse(e):e}})}var o=null,t=null,n={};n.init=function(o){null==t&&e(o)},n.getPokemonName=function(e){return o[e]},n.getItemName=function(e){return t[e]};var i={93:1,94:1,135:1.5,166:2,192:2.5,215:3,236:3.5,255:4,273:4.5,290:5,306:5.5,321:6,335:6.5,349:7,362:7.5,375:8,387:8.5,399:9,411:9.5,422:10,432:10.5,443:11,453:11.5,462:12,472:12.5,481:13,490:13.5,499:14,508:14.5,517:15,525:15.5,534:16,542:16.5,550:17,558:17.5,566:18,574:18.5,582:19,589:19.5,597:20,604:20.5,612:21,619:21.5,626:22,633:22.5,640:23,647:23.5,654:24,661:24.5,667:25,674:25.5,681:26,687:26.5,694:27,700:27.5,706:28,713:28.5,719:29,725:29.5,731:30,734:30.5,737:31,740:31.5,743:32,746:32.5,749:33,752:33.5,755:34,758:34.5,761:35,764:35.5,767:36,770:36.5,773:37,776:37.5,778:38,781:38.5,784:39,790:40};n.getPokemonLevel=function(e){var o=1e3*(e.combat_power_multiplier+e.additional_cp_multiplier);return i[0|o]},window.inventoryService=n}();var Map=function(e){var o=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),t=L.tileLayer("http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png"),n=L.tileLayer("http://{s}.tile2.opencyclemap.org/transport/{z}/{x}/{y}.png"),i=L.tileLayer("http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png"),s=L.tileLayer("http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg");this.layerPokestops=new L.LayerGroup,this.layerCatches=new L.LayerGroup,this.layerPath=new L.LayerGroup,this.map=L.map(e,{layers:[o,this.layerPokestops,this.layerCatches,this.layerPath]});var a={OpenStreetMap:o,OpenCycleMap:t,"OpenCycleMap Transport":n,Toner:i,Watercolor:s},r={Path:this.layerPath,Pokestops:this.layerPokestops,Catches:this.layerCatches};L.control.layers(a,r).addTo(this.map),this.path=null,this.steps=[],this.catches=[],this.pokestops=[],this.pokemonList=[]};Map.prototype.saveContext=function(){var e=Array.from(this.pokestops,function(e){return{id:e.id,lat:e.lat,lng:e.lng,visited:e.visited}});sessionStorage.setItem("available",!0),sessionStorage.setItem("steps",JSON.stringify(this.steps)),sessionStorage.setItem("catches",JSON.stringify(this.catches)),sessionStorage.setItem("pokestops",JSON.stringify(e))},Map.prototype.loadContext=function(){try{"true"==sessionStorage.getItem("available")&&(console.log("Load data from storage to restore session"),this.steps=JSON.parse(sessionStorage.getItem("steps"))||[],this.catches=JSON.parse(sessionStorage.getItem("catches"))||[],this.pokestops=JSON.parse(sessionStorage.getItem("pokestops"))||[],this.steps.length>0&&this.initPath(),this.initPokestops(),this.initCatches(),sessionStorage.setItem("available",!1))}catch(e){console.log(e)}},Map.prototype.initPath=function(){if(null!=this.path)return!0;if(!this.me){var e=this.steps[this.steps.length-1];this.map.setView([e.lat,e.lng],16),this.me=L.marker([e.lat,e.lng],{zIndexOffset:200}).addTo(this.map).bindPopup(e.lat.toFixed(4)+","+e.lng.toFixed(4)),$(".loading").hide()}if(this.steps.length>=2){var o=Array.from(this.steps,function(e){return L.latLng(e.lat,e.lng)});return this.path=L.polyline(o,{color:"red"}).addTo(this.layerPath),!0}return!1},Map.prototype.initCatches=function(){for(var e=0;e<this.catches.length;e++){var o=this.catches[e],t=L.icon({iconUrl:"./assets/pokemon/"+o.id+".png",iconSize:[50,50],iconAnchor:[20,20]}),n=o.name+" <br /> Cp:"+o.cp+" Iv:"+o.iv+"%";o.lvl&&(n=o.name+" (lvl "+o.lvl+") <br /> Cp:"+o.cp+" Iv:"+o.iv+"%"),L.marker([o.lat,o.lng],{icon:t,zIndexOffset:100}).bindPopup(n).addTo(this.layerCatches)}},Map.prototype.initPokestops=function(){for(var e=0;e<this.pokestops.length;e++){var o=this.pokestops[e],t=o.visited?"./assets/img/pokestop_visited.png":"./assets/img/pokestop_available.png",n=L.icon({iconUrl:t,iconSize:[40,40],iconAnchor:[20,20]});o.marker=L.marker([o.lat,o.lng],{icon:n,zIndexOffset:50}).bindPopup(o.name).addTo(this.layerPokestops)}},Map.prototype.addToPath=function(e){if(this.steps.push(e),global.config.memory.limit&&this.steps.length>global.config.memory.mathPath){this.layerPath.clearLayers(),this.path=null;var o=Math.floor(.7*global.config.memory.mathPath);this.steps=this.steps.slice(-o)}if(this.initPath()){var t=L.latLng(e.lat,e.lng);this.path.addLatLng(t),this.me.setLatLng(t).getPopup().setContent(e.lat.toFixed(4)+","+e.lng.toFixed(4)),global.config.followPlayer&&this.map.panTo(t,!0)}},Map.prototype.addCatch=function(e){if(!e.lat){if(this.steps.length<=0)return;var o=this.steps[this.steps.length-1];e.lat=o.lat,e.lng=o.lng}var t=e.name+"<br /> CP:"+e.cp+" IV:"+e.iv+"%";if(e.lvl&&(t=e.name+" (lvl "+e.lvl+") <br /> Cp:"+e.cp+" Iv:"+e.iv+"%"),this.catches.push(e),global.config.memory.limit&&this.catches.length>global.config.memory.maxCaught){console.log("Clean catches");var n=Math.floor(.7*global.config.memory.maxCaught);this.catches=this.catches.slice(-n),this.layerCatches.clearLayers(),this.initCatches()}else{var i=L.icon({iconUrl:"./assets/pokemon/"+e.id+".png",iconSize:[50,50],iconAnchor:[25,25]});L.marker([e.lat,e.lng],{icon:i,zIndexOffset:100}).bindPopup(t).addTo(this.layerCatches)}},Map.prototype.addVisitedPokestop=function(e){if(e.lat){var o=this.pokestops.find(function(o){return o.id==e.id});if(o)Object.assign(o,e);else{this.pokestops.push(e),o=e;var t=L.icon({iconUrl:"./assets/img/pokestop_cooldown.png",iconSize:[40,40],iconAnchor:[20,20]});e.marker=L.marker([e.lat,e.lng],{icon:t,zIndexOffset:50}).addTo(this.layerPokestops)}o.visited=!0,o&&o.marker&&(o.marker.setIcon(L.icon({iconUrl:"./assets/img/pokestop_cooldown.png",iconSize:[40,40],iconAnchor:[20,20]})),o.name&&o.marker.bindPopup(o.name))}},Map.prototype.addPokestops=function(e){for(var o=0;o<e.length;o++){var t=e[o],n=this.pokestops.find(function(e){return e.id==t.id});n?t=Object.assign(n,t):this.pokestops.push(t);var i="pokestop_available";if(t.cooldown&&moment(t.cooldown).isAfter()?i="pokestop_cooldown":t.lureExpire&&moment(t.lureExpire).isAfter()?i="pokestop_lure":t.visited&&(i="pokestop_visited"),t.marker)t.marker.setIcon(L.icon({iconUrl:"./assets/img/"+i+".png",iconSize:[40,40],iconAnchor:[20,20]}));else{var i=L.icon({iconUrl:"./assets/img/"+i+".png",iconSize:[40,40],iconAnchor:[20,20]});t.marker=L.marker([t.lat,t.lng],{icon:i,zIndexOffset:50}).addTo(this.layerPokestops)}}global.config.memory.limit&&this.pokestops.length>global.config.memory.maxPokestops},Map.prototype.updatePokestopsStatus=function(){this.pokestops.forEach(function(e){var o=!1;if(e.cooldown&&moment(e.cooldown).isBefore()?(e.cooldown=null,o=!0):e.lureExpire&&moment(e.lureExpire).isBefore()&&(e.lureExpire=null,o=!0),o){var t="pokestop_available";e.cooldown&&moment(e.cooldown).isAfter()?t="pokestop_cooldown":e.lureExpire&&moment(e.lureExpire).isAfter()?t="pokestop_lure":e.visited&&(t="pokestop_visited"),e.marker.setIcon(L.icon({iconUrl:"./assets/img/"+t+".png",iconSize:[40,40],iconAnchor:[20,20]}))}})},Map.prototype.displayPokemonList=function(e,o,t){console.log("Pokemon list"),global.active="pokemon",this.pokemonList=e||this.pokemonList,this.eggsCount=t||this.eggsCount||0,o?localStorage.setItem("sortPokemonBy",o):o=localStorage.getItem("sortPokemonBy")||"cp","pokemonId"==o?this.pokemonList=this.pokemonList.sort(function(e,t){if(e[o]!=t[o])return e[o]-t[o];var n=t.cp!=e.cp?"cp":"iv";return t[n]-e[n]}):this.pokemonList=this.pokemonList.sort(function(e,t){if(e[o]!=t[o])return t[o]-e[o];if(e.pokemonId!=t.pokemonId)return e.pokemonId-t.pokemonId;var n="cp"==o?"iv":"cp";return t[n]-e[n]});var n=this.eggsCount+this.pokemonList.length;$(".inventory .numberinfo").text(n+"/"+global.storage.pokemon);var i=$(".inventory .data");i.html(""),this.pokemonList.forEach(function(e){var o=e.canEvolve&&!e.inGym&&e.candy>=e.candyToEvolve,t=o?"":"style='display:none'",n=o?"canEvolve":"",s=e.favorite?"style='display:none'":"",a=e.canEvolve?"":"style='display:none'";i.append('\n            <div class="pokemon">\n                <div class="transfer" data-id=\''+e.id+"'>\n                    <a title='Transfer' href=\"#\" class=\"transferAction "+s+'"><img src="./assets/img/recyclebin.png" /></a>\n                    <a title=\'Evolve\' href="#" class="evolveAction" '+t+'><img src="./assets/img/evolve.png" /></a>\n                </div>\n                <span class="imgspan '+n+'"><img src="./assets/pokemon/'+e.pokemonId+'.png" /></span>\n                <span class="name">'+e.name+'</span>\n                <span class="info">CP: <strong>'+e.cp+"</strong> IV: <strong>"+e.iv+'%</strong></span>\n                <span class="info">ATK: <strong>'+e.stats.atk+"</strong> DEF: <strong>"+e.stats.def+"</strong> STA: <strong>"+e.stats.sta+'</strong></span>\n                <span class="info">Candy: '+e.candy+"<span "+a+">/"+e.candyToEvolve+"</span></span>\n            </div>\n        ")}),$(".pokemonsort").show(),$(".inventory").show().addClass("active")},Map.prototype.displayEggsList=function(e){console.log("Eggs list"),global.active="eggs",$(".inventory .sort").hide(),$(".inventory .numberinfo").text(e.length+"/9");var o=$(".inventory .data");o.html(""),e.forEach(function(e){e&&o.append('\n                <div class="eggs">\n                    <span class="imgspan"><img src="./assets/inventory/'+e.type+'.png" /></span>\n                    <span>'+e.doneDist.toFixed(1)+" / "+e.totalDist.toFixed(1)+" km</span>\n                </div>\n            ")}),$(".inventory").show().addClass("active")},Map.prototype.displayInventory=function(e){console.log("Inventory list"),global.active="inventory",$(".inventory .sort").hide();var o=e.filter(function(e){return 901!=e.item_id}).reduce(function(e,o){return e+o.count},0);$(".inventory .numberinfo").text(o+"/"+global.storage.items);var t=$(".inventory .data");t.html(""),e.forEach(function(e){t.append('\n            <div class="items">\n                <span>x'+e.count+'</span>\n                <span class="imgspan"><img src="./assets/inventory/'+e.item_id+'.png" /></span>\n                <span class="info">'+e.name+"</span>\n            </div>\n        ")}),$(".inventory").show().addClass("active")};var inventory=window.inventoryService;!function(){function e(e,t){o.config.noConfirm?t():vex.dialog.confirm({message:e,callback:function(e){e&&t()}})}var o={storage:{items:350,pokemon:250},snipping:!1};window.global=o,o.config=window.configService.load(),o.version=o.config.version,document.title+=" - "+o.version,$(function(){window.ga=window.ga||function(){};var t=localStorage.getItem("sortPokemonBy")||"cp";$("#sortBy"+t).addClass("active").siblings().removeClass("active"),$("#pokemonLink").click(function(){"1"==$(".inventory").css("opacity")&&$(".inventory .data .pokemon").length?$(".inventory").removeClass("active"):o.ws.emit("pokemon_list")}),$("#eggsLink").click(function(){"1"==$(".inventory").css("opacity")&&$(".inventory .data .eggs").length?$(".inventory").removeClass("active"):o.ws.emit("eggs_list")}),$("#inventoryLink").click(function(){"1"==$(".inventory").css("opacity")&&$(".inventory .data .items").length?$(".inventory").removeClass("active"):o.ws.emit("inventory_list")}),$("#sortBypokemonId").click(function(){return o.map.displayPokemonList(null,"pokemonId")}),$("#sortBycp").click(function(){return o.map.displayPokemonList(null,"cp")}),$("#sortByiv").click(function(){return o.map.displayPokemonList(null,"iv")}),$("#sortBypokemonId, #sortBycp, #sortByiv").click(function(){$(this).hasClass("active")||$(this).toggleClass("active").siblings().removeClass("active")}),$(".inventory .refresh").click(function(){console.log("Refresh"),o.ws.emit(o.active+"_list")}),$(".inventory .close").click(function(){$(this).parent().removeClass("active"),$(".inventory .sort").hide()}),$(".message .close").click(function(){$(this).parent().hide()}),$(".close").click(function(){o.active=null}),$("#recycleLink").click(function(){sessionStorage.setItem("available",!1),window.location.reload()}),$("#settingsLink").click(function(){o.map.saveContext(),window.location="config.html"}),$(".inventory .data").on("click","a.transferAction",function(){var t=$(this).parent(),n=t.data().id,i=o.map.pokemonList.findIndex(function(e){return e.id==n}),s=o.map.pokemonList[i],a=o.map.pokemonList.filter(function(e){return e.pokemonId==s.pokemonId}),r=a.length-1,l=window.inventoryService.getPokemonName(s.pokemonId),p="Are you sure you want to transfer this "+l+"? <br /> You will have <b>"+r+"</b> left.";e(p,function(){ga("send","event","transfer",s.pokemonId),o.ws.emit("transfer_pokemon",{id:n}),o.map.pokemonList.splice(i,1),t.parent().fadeOut()})}),$(".inventory .data").on("click","a.evolveAction",function(){var t=$(this).parent(),n=t.data().id,i=o.map.pokemonList.findIndex(function(e){return e.id==n}),s=o.map.pokemonList[i],a=o.map.pokemonList.filter(function(e){return e.pokemonId==s.pokemonId}),r=a.length-1,l=window.inventoryService.getPokemonName(s.pokemonId),p="Are you sure you want to evolve this "+l+"? <br /> You will have <b>"+r+"</b> left.";e(p,function(){ga("send","event","evolve",s.pokemonId),o.ws.emit("evolve_pokemon",{id:n}),o.map.pokemonList.splice(i,1),t.parent().fadeOut()})}),$(".player").on("pogo:player_update",function(){if(o.player){var e=$(".player");e.find(".playername .value").text(o.user),e.find(".level .value").text(o.player.level);var t=100*(o.player.experience-o.player.prev_level_xp)/(o.player.next_level_xp-o.player.prev_level_xp);e.find(".progress .value").css("width",t.toFixed(0)+"%"),e.show()}}),o.config.websocket?(o.map=new Map("map"),o.map.loadContext(),startListenToSocket()):window.location="config.html"})}(),$(function(){function e(e,o){e=e.replace(/[a-z]/g,""),o=o.replace(/[a-z]/g,"");var t,n,i=/(\.0+)+$/,s=e.replace(i,"").split("."),a=o.replace(i,"").split("."),r=Math.min(s.length,a.length);for(t=0;t<r;t++)if(n=parseInt(s[t],10)-parseInt(a[t],10))return n;return s.length-a.length}function o(){try{var o="https://api.github.com/repos/nicoschmitt/necrobotvisualizer/releases";$.getJSON(o,function(o){o=o.filter(function(e){return!e.prerelease&&!e.draft});var t=o[0].name,n=o[0].html_url;e(t,global.version)>0&&(console.log("New version available: "+t),$(".message .data").html("<div>New version available. Check on GitHub to download it. <a href='"+n+"'>Here</a></div>"),$(".message").show())})}catch(e){console.log(e)}}"function"==typeof require&&o()});